<div class="teams-container">
  <app-header 
    title="My Teams"
    [logoWithTagline]="false" 
    [navLinks]="navLinks"
    [showLogoLink]="true" />

  <main class="teams-content">
    @if (loading()) {
      <div class="loading-container">
        <p>Loading teams...</p>
      </div>
    } @else if (error()) {
      <div class="error-container">
        <p>{{ error() }}</p>
        <button (click)="loadTeams()" class="retry-button">Retry</button>
      </div>
    } @else {
      <div class="teams-header">
        <h1>My Teams</h1>
        <div class="header-actions">
          @if (!selectionMode()) {
            <button 
              (click)="toggleSelectionMode()" 
              class="selection-mode-button"
              title="Enable selection mode to select multiple teams for bulk deletion">
              <span class="button-icon">‚òë</span>
              <span>Selection Mode</span>
            </button>
            <button 
              (click)="toggleCreateForm()" 
              class="create-button"
              [class.active]="showCreateForm()">
              {{ showCreateForm() ? 'Cancel' : '+ Create Team' }}
            </button>
          } @else {
            <button 
              (click)="toggleSelectionMode()" 
              class="cancel-selection-button">
              ‚úï Cancel Selection
            </button>
          }
        </div>
      </div>

      @if (selectionMode()) {
        <div class="selection-bar">
          <div class="selection-controls">
            <label class="select-all-checkbox">
              <input 
                type="checkbox" 
                [checked]="isAllSelected()"
                (change)="toggleSelectAll()"
                class="checkbox-input">
              <span class="checkbox-label">Select All</span>
            </label>
            <span class="selection-count">{{ getSelectedCount() }} selected</span>
          </div>
          <button 
            (click)="deleteSelectedTeams()" 
            class="bulk-delete-button"
            [disabled]="!isSomeSelected() || bulkDeleting()">
            {{ bulkDeleting() ? 'Deleting...' : 'üóëÔ∏è Delete Selected' }}
          </button>
        </div>
        @if (bulkDeleteError()) {
          <div class="error-message-container" style="margin-bottom: 1rem;">
            <p class="error-message">{{ bulkDeleteError() }}</p>
          </div>
        }
      }

      @if (showCreateForm() && !selectionMode()) {
        <div class="create-form-container">
          <h2>Create New Team</h2>
          <form [formGroup]="createTeamForm" (ngSubmit)="onSubmit()" class="create-form">
            <div class="form-group">
              <label for="name">Team Name *</label>
              <input 
                type="text" 
                id="name" 
                formControlName="name"
                class="form-input"
                [class.error]="createTeamForm.get('name')?.invalid && createTeamForm.get('name')?.touched"
                placeholder="Enter team name">
              @if (createTeamForm.get('name')?.invalid && createTeamForm.get('name')?.touched) {
                <span class="error-message">Team name is required (max 200 characters)</span>
              }
            </div>

            <div class="form-group">
              <label for="description">Description</label>
              <textarea 
                id="description" 
                formControlName="description"
                class="form-textarea"
                rows="4"
                placeholder="Enter team description (optional)"></textarea>
              @if (createTeamForm.get('description')?.invalid && createTeamForm.get('description')?.touched) {
                <span class="error-message">Description must be less than 1000 characters</span>
              }
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="startDate">Start Date *</label>
                <input 
                  type="date" 
                  id="startDate" 
                  formControlName="startDate"
                  class="form-input"
                  [class.error]="createTeamForm.get('startDate')?.invalid && createTeamForm.get('startDate')?.touched">
              @if (createTeamForm.get('startDate')?.invalid && createTeamForm.get('startDate')?.touched) {
                <span class="error-message">Start date is required</span>
              }
              </div>

              <div class="form-group">
                <label for="endDate">End Date</label>
                <input 
                  type="date" 
                  id="endDate" 
                  formControlName="endDate"
                  class="form-input"
                  placeholder="Optional">
              </div>
            </div>

            @if (createError()) {
              <div class="error-message-container">
                <p class="error-message">{{ createError() }}</p>
              </div>
            }

            <div class="form-actions">
              <button 
                type="submit" 
                class="submit-button"
                [disabled]="creating() || createTeamForm.invalid">
                {{ creating() ? 'Creating...' : 'Create Team' }}
              </button>
            </div>
          </form>
        </div>
      }

      @if (teams().length === 0) {
        <div class="empty-container">
          <p>You don't have any teams yet.</p>
          <p>Create your first team to get started!</p>
        </div>
      } @else {
        <div class="teams-list">
          @for (team of teams(); track team.uuid) {
            <div class="team-card" 
                 [class.selected]="selectionMode() && isTeamSelected(team.uuid)"
                 [class.selection-mode-active]="selectionMode()">
              @if (selectionMode()) {
                <div class="team-card-checkbox">
                  <input 
                    type="checkbox" 
                    [checked]="isTeamSelected(team.uuid)"
                    (change)="toggleTeamSelection(team.uuid)"
                    class="checkbox-input"
                    [id]="'team-checkbox-' + team.uuid">
                  <label [for]="'team-checkbox-' + team.uuid" class="checkbox-label"></label>
                </div>
              }
              @if (editingTeamUuid() === team.uuid) {
                <div class="edit-form-container">
                  <h2>Edit Team</h2>
                  <form [formGroup]="editTeamForm" (ngSubmit)="onUpdate()" class="edit-form">
                    <div class="form-group">
                      <label for="edit-name">Team Name *</label>
                      <input 
                        type="text" 
                        id="edit-name" 
                        formControlName="name"
                        class="form-input"
                        [class.error]="editTeamForm.get('name')?.invalid && editTeamForm.get('name')?.touched"
                        placeholder="Enter team name">
                      @if (editTeamForm.get('name')?.invalid && editTeamForm.get('name')?.touched) {
                        <span class="error-message">Team name is required (max 200 characters)</span>
                      }
                    </div>

                    <div class="form-group">
                      <label for="edit-description">Description</label>
                      <textarea 
                        id="edit-description" 
                        formControlName="description"
                        class="form-textarea"
                        rows="4"
                        placeholder="Enter team description (optional)"></textarea>
                      @if (editTeamForm.get('description')?.invalid && editTeamForm.get('description')?.touched) {
                        <span class="error-message">Description must be less than 1000 characters</span>
                      }
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label for="edit-startDate">Start Date *</label>
                        <input 
                          type="date" 
                          id="edit-startDate" 
                          formControlName="startDate"
                          class="form-input"
                          [class.error]="editTeamForm.get('startDate')?.invalid && editTeamForm.get('startDate')?.touched">
                        @if (editTeamForm.get('startDate')?.invalid && editTeamForm.get('startDate')?.touched) {
                          <span class="error-message">Start date is required</span>
                        }
                      </div>

                      <div class="form-group">
                        <label for="edit-endDate">End Date</label>
                        <input 
                          type="date" 
                          id="edit-endDate" 
                          formControlName="endDate"
                          class="form-input"
                          placeholder="Optional">
                      </div>
                    </div>

                    @if (updateError()) {
                      <div class="error-message-container">
                        <p class="error-message">{{ updateError() }}</p>
                      </div>
                    }

                    <div class="form-actions">
                      <button 
                        type="button" 
                        (click)="cancelEdit()"
                        class="cancel-button">
                        Cancel
                      </button>
                      <button 
                        type="submit" 
                        class="submit-button"
                        [disabled]="updating() || editTeamForm.invalid">
                        {{ updating() ? 'Updating...' : 'Update Team' }}
                      </button>
                    </div>
                  </form>
                </div>
              } @else {
                <div class="team-card-header">
                  <h3 class="team-name">{{ team.name || 'Unnamed Team' }}</h3>
                  <span class="team-uuid">{{ team.uuid }}</span>
                </div>
                @if (team.description) {
                  <p class="team-description">{{ team.description }}</p>
                }
                <div class="team-dates">
                  <div class="date-item">
                    <span class="date-label">Start:</span>
                    <span class="date-value">{{ formatDate(team.startDate) }}</span>
                  </div>
                  @if (team.endDate) {
                    <div class="date-item">
                      <span class="date-label">End:</span>
                      <span class="date-value">{{ formatDate(team.endDate) }}</span>
                    </div>
                  }
                </div>
                
                @if (!selectionMode()) {
                  <div class="projects-section">
                    <button 
                      (click)="toggleProjects(team)" 
                      class="projects-toggle-button"
                      [class.expanded]="isProjectsExpanded(team.uuid)">
                      <span class="projects-toggle-icon">{{ isProjectsExpanded(team.uuid) ? '‚ñº' : '‚ñ∂' }}</span>
                      <span class="projects-toggle-text">
                        Projects
                        @if (getTeamProjects(team.uuid).length > 0) {
                          <span class="projects-count">({{ getTeamProjects(team.uuid).length }})</span>
                        }
                      </span>
                    </button>
                    
                    @if (isProjectsExpanded(team.uuid)) {
                      <div class="projects-content">
                        <div class="projects-header-actions">
                          <button 
                            (click)="startCreateProject(team.uuid || '')" 
                            class="create-project-button"
                            [disabled]="isLoadingProjects(team.uuid)">
                            + Create Project
                          </button>
                        </div>
                        @if (isLoadingProjects(team.uuid)) {
                          <div class="projects-loading">
                            <p>Loading projects...</p>
                          </div>
                        } @else if (getProjectsError(team.uuid)) {
                          <div class="projects-error">
                            <p>{{ getProjectsError(team.uuid) }}</p>
                            <button 
                              (click)="loadProjects(team.uuid || '')" 
                              class="retry-projects-button">
                              Retry
                            </button>
                          </div>
                        } @else if (getTeamProjects(team.uuid).length === 0) {
                          <div class="projects-empty">
                            <p>No projects found for this team.</p>
                            <button 
                              (click)="startCreateProject(team.uuid || '')" 
                              class="create-project-button">
                              Create Your First Project
                            </button>
                          </div>
                        } @else {
                          <div class="projects-list">
                            @for (project of getTeamProjects(team.uuid); track project.uuid) {
                              <div class="project-item">
                                <div class="project-header">
                                  <h4 class="project-name">{{ project.name || 'Unnamed Project' }}</h4>
                                  @if (project.uuid) {
                                    <span class="project-uuid">{{ project.uuid }}</span>
                                  }
                                </div>
                                @if (project.description) {
                                  <p class="project-description">{{ project.description }}</p>
                                }
                                <div class="project-dates">
                                  @if (project.startDate) {
                                    <div class="project-date-item">
                                      <span class="project-date-label">Start:</span>
                                      <span class="project-date-value">{{ formatDate(project.startDate) }}</span>
                                    </div>
                                  }
                                  @if (project.endDate) {
                                    <div class="project-date-item">
                                      <span class="project-date-label">End:</span>
                                      <span class="project-date-value">{{ formatDate(project.endDate) }}</span>
                                    </div>
                                  }
                                </div>
                                <div class="project-actions">
                                  <button 
                                    (click)="startEditProject(project, team.uuid || '')" 
                                    class="edit-project-button"
                                    [disabled]="isDeletingProject(project.uuid)">
                                    Edit
                                  </button>
                                  <button 
                                    (click)="deleteProject(project, team.uuid || '')" 
                                    class="delete-project-button"
                                    [disabled]="isDeletingProject(project.uuid)">
                                    {{ isDeletingProject(project.uuid) ? 'Deleting...' : 'Delete' }}
                                  </button>
                                </div>
                                @if (getDeleteProjectError(project.uuid)) {
                                  <div class="error-message-container" style="margin-top: 1rem;">
                                    <p class="error-message">{{ getDeleteProjectError(project.uuid) }}</p>
                                  </div>
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
                
                @if (!selectionMode()) {
                  <div class="team-card-actions">
                    <button 
                      (click)="startEdit(team)" 
                      class="edit-button"
                      [disabled]="deletingTeamUuid() === team.uuid">
                      Edit
                    </button>
                    <button 
                      (click)="deleteTeam(team)" 
                      class="delete-button"
                      [disabled]="deletingTeamUuid() === team.uuid">
                      {{ deletingTeamUuid() === team.uuid ? 'Deleting...' : 'Delete' }}
                    </button>
                  </div>
                }
                @if (deleteError() && deletingTeamUuid() === team.uuid) {
                  <div class="error-message-container" style="margin-top: 1rem;">
                    <p class="error-message">{{ deleteError() }}</p>
                  </div>
                }
              }
            </div>
          }
        </div>
      }
    }
  </main>

  <!-- Project Create Modal -->
  @if (creatingProjectTeamUuid()) {
    <div class="modal-overlay" (click)="cancelCreateProject()">
      <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Create New Project</h2>
          <button class="modal-close-button" (click)="cancelCreateProject()" type="button">√ó</button>
        </div>
        <div class="modal-body">
          <form [formGroup]="createProjectForm" (ngSubmit)="onCreateProject()" class="edit-project-form">
            <div class="form-section">
              <h3 class="form-section-title">Basic Information</h3>
              <div class="form-group">
                <label for="create-project-name">Project Name *</label>
                <input 
                  type="text" 
                  id="create-project-name" 
                  formControlName="name"
                  class="form-input"
                  [class.error]="createProjectForm.get('name')?.invalid && createProjectForm.get('name')?.touched"
                  placeholder="Enter project name">
                @if (createProjectForm.get('name')?.invalid && createProjectForm.get('name')?.touched) {
                  <span class="error-message">Project name is required (max 200 characters)</span>
                }
              </div>

              <div class="form-group">
                <label for="create-project-description">Description</label>
                <textarea 
                  id="create-project-description" 
                  formControlName="description"
                  class="form-textarea"
                  rows="4"
                  placeholder="Enter project description (optional)"></textarea>
                @if (createProjectForm.get('description')?.invalid && createProjectForm.get('description')?.touched) {
                  <span class="error-message">Description must be less than 1000 characters</span>
                }
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="create-project-startDate">Start Date *</label>
                  <input 
                    type="date" 
                    id="create-project-startDate" 
                    formControlName="startDate"
                    class="form-input"
                    [class.error]="createProjectForm.get('startDate')?.invalid && createProjectForm.get('startDate')?.touched">
                  @if (createProjectForm.get('startDate')?.invalid && createProjectForm.get('startDate')?.touched) {
                    <span class="error-message">Start date is required</span>
                  }
                </div>

                <div class="form-group">
                  <label for="create-project-endDate">End Date</label>
                  <input 
                    type="date" 
                    id="create-project-endDate" 
                    formControlName="endDate"
                    class="form-input"
                    placeholder="Optional">
                </div>
              </div>

              <div class="form-group">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    formControlName="active"
                    class="checkbox-input">
                  <span>Active Project</span>
                </label>
              </div>
            </div>

            <div class="form-section">
              <h3 class="form-section-title">Project Configuration</h3>
              <div class="form-row">
                <div class="form-group">
                  <label for="create-iteration-duration">Iteration Duration *</label>
                  <input 
                    type="number" 
                    id="create-iteration-duration" 
                    formControlName="iterationDuration"
                    class="form-input"
                    [class.error]="createProjectForm.get('iterationDuration')?.invalid && createProjectForm.get('iterationDuration')?.touched"
                    min="1"
                    placeholder="e.g., 14">
                  @if (createProjectForm.get('iterationDuration')?.invalid && createProjectForm.get('iterationDuration')?.touched) {
                    <span class="error-message">Iteration duration is required (minimum 1)</span>
                  }
                </div>

                <div class="form-group">
                  <label for="create-iteration-duration-unit">Iteration Duration Unit *</label>
                  <select 
                    id="create-iteration-duration-unit"
                    formControlName="iterationDurationUnit"
                    class="form-input"
                    [class.error]="createProjectForm.get('iterationDurationUnit')?.invalid && createProjectForm.get('iterationDurationUnit')?.touched">
                    <option value="DAYS">Days</option>
                    <option value="WEEKS">Weeks</option>
                    <option value="MONTHS">Months</option>
                  </select>
                  @if (createProjectForm.get('iterationDurationUnit')?.invalid && createProjectForm.get('iterationDurationUnit')?.touched) {
                    <span class="error-message">Iteration duration unit is required</span>
                  }
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="create-capacity-unit">Capacity Unit *</label>
                  <select 
                    id="create-capacity-unit"
                    formControlName="capacityUnit"
                    class="form-input"
                    [class.error]="createProjectForm.get('capacityUnit')?.invalid && createProjectForm.get('capacityUnit')?.touched">
                    <option value="STORY_POINTS">Story Points</option>
                    <option value="T_SHIRT">T-Shirt Sizes</option>
                  </select>
                  @if (createProjectForm.get('capacityUnit')?.invalid && createProjectForm.get('capacityUnit')?.touched) {
                    <span class="error-message">Capacity unit is required</span>
                  }
                </div>

                <div class="form-group">
                  <label for="create-forecast-unit">Forecast Unit *</label>
                  <select 
                    id="create-forecast-unit"
                    formControlName="forecastUnit"
                    class="form-input"
                    [class.error]="createProjectForm.get('forecastUnit')?.invalid && createProjectForm.get('forecastUnit')?.touched">
                    <option value="MAN_DAYS">Man-Days</option>
                  </select>
                  @if (createProjectForm.get('forecastUnit')?.invalid && createProjectForm.get('forecastUnit')?.touched) {
                    <span class="error-message">Forecast unit is required</span>
                  }
                </div>
              </div>
            </div>

            @if (createProjectError()) {
              <div class="error-message-container">
                <p class="error-message">{{ createProjectError() }}</p>
              </div>
            }

            <div class="modal-actions">
              <button 
                type="button" 
                (click)="cancelCreateProject()"
                class="cancel-button">
                Cancel
              </button>
              <button 
                type="submit" 
                class="submit-button"
                [disabled]="creatingProject() || createProjectForm.invalid">
                {{ creatingProject() ? 'Creating...' : 'Create Project' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Project Edit Modal -->
  @if (editingProjectUuid()) {
    <div class="modal-overlay" (click)="cancelEditProject()">
      <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Edit Project</h2>
          <button class="modal-close-button" (click)="cancelEditProject()" type="button">√ó</button>
        </div>
        <div class="modal-body">
          <form [formGroup]="editProjectForm" (ngSubmit)="onUpdateProject(getCurrentTeamUuid())" class="edit-project-form">
            <div class="form-section">
              <h3 class="form-section-title">Basic Information</h3>
              <div class="form-group">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <label for="edit-project-name">Project Name *</label>
                  <p-tag 
                    [value]="editProjectForm.get('active')?.value ? 'Active' : 'Inactive'"
                    [severity]="editProjectForm.get('active')?.value ? 'success' : 'secondary'">
                  </p-tag>
                </div>
                <input 
                  type="text" 
                  id="edit-project-name" 
                  formControlName="name"
                  class="form-input"
                  [class.error]="editProjectForm.get('name')?.invalid && editProjectForm.get('name')?.touched"
                  placeholder="Enter project name">
                @if (editProjectForm.get('name')?.invalid && editProjectForm.get('name')?.touched) {
                  <span class="error-message">Project name is required (max 200 characters)</span>
                }
              </div>

              <div class="form-group">
                <label for="edit-project-description">Description</label>
                <textarea 
                  id="edit-project-description" 
                  formControlName="description"
                  class="form-textarea"
                  rows="4"
                  placeholder="Enter project description (optional)"></textarea>
                @if (editProjectForm.get('description')?.invalid && editProjectForm.get('description')?.touched) {
                  <span class="error-message">Description must be less than 1000 characters</span>
                }
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="edit-project-startDate">Start Date *</label>
                  <input 
                    type="date" 
                    id="edit-project-startDate" 
                    formControlName="startDate"
                    class="form-input"
                    [class.error]="editProjectForm.get('startDate')?.invalid && editProjectForm.get('startDate')?.touched">
                  @if (editProjectForm.get('startDate')?.invalid && editProjectForm.get('startDate')?.touched) {
                    <span class="error-message">Start date is required</span>
                  }
                </div>

                <div class="form-group">
                  <label for="edit-project-endDate">End Date</label>
                  <input 
                    type="date" 
                    id="edit-project-endDate" 
                    formControlName="endDate"
                    class="form-input"
                    placeholder="Optional">
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3 class="form-section-title">Project Configuration</h3>
              <div class="form-row">
                <div class="form-group">
                  <label for="iteration-duration">Iteration Duration *</label>
                  <input 
                    type="number" 
                    id="iteration-duration" 
                    formControlName="iterationDuration"
                    class="form-input"
                    [class.error]="editProjectForm.get('iterationDuration')?.invalid && editProjectForm.get('iterationDuration')?.touched"
                    min="1"
                    placeholder="e.g., 14">
                  @if (editProjectForm.get('iterationDuration')?.invalid && editProjectForm.get('iterationDuration')?.touched) {
                    <span class="error-message">Iteration duration is required (minimum 1)</span>
                  }
                </div>

                <div class="form-group">
                  <label for="iteration-duration-unit">Iteration Duration Unit *</label>
                  <select 
                    id="iteration-duration-unit"
                    formControlName="iterationDurationUnit"
                    class="form-input"
                    [class.error]="editProjectForm.get('iterationDurationUnit')?.invalid && editProjectForm.get('iterationDurationUnit')?.touched">
                    <option value="DAYS">Days</option>
                    <option value="WEEKS">Weeks</option>
                    <option value="MONTHS">Months</option>
                  </select>
                  @if (editProjectForm.get('iterationDurationUnit')?.invalid && editProjectForm.get('iterationDurationUnit')?.touched) {
                    <span class="error-message">Iteration duration unit is required</span>
                  }
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="capacity-unit">Capacity Unit *</label>
                  <select 
                    id="capacity-unit"
                    formControlName="capacityUnit"
                    class="form-input"
                    [class.error]="editProjectForm.get('capacityUnit')?.invalid && editProjectForm.get('capacityUnit')?.touched">
                    <option value="STORY_POINTS">Story Points</option>
                    <option value="T_SHIRT">T-Shirt Sizes</option>
                  </select>
                  @if (editProjectForm.get('capacityUnit')?.invalid && editProjectForm.get('capacityUnit')?.touched) {
                    <span class="error-message">Capacity unit is required</span>
                  }
                </div>

                <div class="form-group">
                  <label for="forecast-unit">Forecast Unit *</label>
                  <select 
                    id="forecast-unit"
                    formControlName="forecastUnit"
                    class="form-input"
                    [class.error]="editProjectForm.get('forecastUnit')?.invalid && editProjectForm.get('forecastUnit')?.touched">
                    <option value="MAN_DAYS">Man-Days</option>
                  </select>
                  @if (editProjectForm.get('forecastUnit')?.invalid && editProjectForm.get('forecastUnit')?.touched) {
                    <span class="error-message">Forecast unit is required</span>
                  }
                </div>
              </div>
            </div>

            @if (updateProjectError()) {
              <div class="error-message-container">
                <p class="error-message">{{ updateProjectError() }}</p>
              </div>
            }

            <div class="modal-actions">
              <button 
                type="button" 
                (click)="cancelEditProject()"
                class="cancel-button">
                Cancel
              </button>
              <button 
                type="submit" 
                class="submit-button"
                [disabled]="updatingProject() || editProjectForm.invalid">
                {{ updatingProject() ? 'Updating...' : 'Update Project' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>

